<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@page import="shop.dao.ProductRepository"%>
<%@page import="java.util.List"%>
<%@page import="shop.dto.Product"%>
<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Products</title>
	<jsp:include page="/layout/meta.jsp" />
	<jsp:include page="/layout/link.jsp" />
</head>
<% 
	String root = request.getContextPath(); 
	String productId = request.getParameter("productId");
	
	ProductRepository productDao = new ProductRepository();
   // 세션에 상품 리스트를 관리하는 'cart' 속성이 있는지 확인
    List<Product> cartList = (List<Product>) session.getAttribute("cartList");
   
    if (productId != null) {
        // 상품 정보를 조회
        Product product = productDao.getProductById(productId);
        if (product != null) {
            if (cartList == null) {
                // 처음으로 상품을 추가하는 경우, 'cart' 속성을 새로 생성
                cartList = new ArrayList<Product>();
                session.setAttribute("cartList", cartList);
            }
            boolean duplicate = false;
            for (Product item : cartList) {
                if (item.getProductId().equals(productId)) {  // 상품 ID를 이용한 중복 확인
                    duplicate = true;
                    item.setQuantity(item.getQuantity() + 1);  // 해당 상품의 수량만 증가
                    break;  // 중복을 찾았으므로 루프 탈출
                }
            }
            
            if (!duplicate) {
                product.setQuantity(1);  // 새 상품이면 수량을 1로 설정
                cartList.add(product);
            }
            // 사용자를 장바구니 페이지로 리디렉트
            response.sendRedirect("products.jsp");
	    } else {
	        // 상품이 존재하지 않는 경우, 오류 처리
	        response.sendRedirect("error.jsp");
	    }
	}
%>
<body>   
	<jsp:include page="/layout/header.jsp" />
	<div class="px-4 py-5 my-5 text-center">
		<h1 class="display-5 fw-bold text-body-emphasis">장바구니</h1>
		<div class="col-lg-6 mx-auto">
			<p class="lead mb-4">장바구니 목록입니다.</p>
			<div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
				
				<table class="table table-striped table-hover table-bordered text-center align-middle">
					<thead>
						<tr class="table-primary">
							<th>상품</th>
							<th>가격</th>
							<th>수량</th>
							<th>소계</th>
							<th>비고</th>
						</tr>
					</thead>
					<tbody>						
						<tr>
							<td>오라클 데이터베이스</td>			
							<td>20000</td>			
							<td>1</td>			
							<td>20000</td>			
							<td><a href="deleteCart.jsp?productId=${product.productId}" class="btn btn-danger">삭제</a></td>			
						</tr>
						
					</tbody>
					<tfoot>
						
						<tr>
							<td></td>
							<td></td>
							<td>총액</td>
							<td id="cart-sum">20000</td>
							<td></td>
						</tr>
						
					</tfoot>
				</table>
			</div>
		</div>
	</div>
	<div class="container">
	    <div class="row justify-content-between">
	        <div class="col-auto">
	            <a href="<%= root %>/shop/products.jsp" class="btn btn-secondary btn-lg">목록</a>
	        </div>
	        <div class="col-auto">
	            <a href="<%= root %>/shop/add_pro.jsp" class="btn btn-primary btn-lg">등록</a>
	        </div>
	    </div>
	</div>


	<jsp:include page="/layout/footer.jsp" />
	<jsp:include page="/layout/script.jsp" />
</body>
</html>





